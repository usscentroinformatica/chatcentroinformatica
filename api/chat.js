const studentSessions = new Map();
const studentData = new Map();

// Funci√≥n para extraer datos del estudiante (sin cambios)
function extractStudentData(message) {
  const data = {};
  const issues = [];
  
  // Extraer nombre
  const nombreMatch = message.match(/(?:mi nombre es|me llamo|soy)\s+([a-z√°√©√≠√≥√∫√º√±\s]+?)(?:,|\s+\d{4}|$)/i);
  if (nombreMatch && nombreMatch[1].trim().split(' ').length >= 2) {
    data.nombre = nombreMatch[1].trim();
  }
  
  // Extraer ciclo - CR√çTICO: Validar elegibilidad
  const cicloMatch = message.match(/(\d{4}-[12])/);
  if (cicloMatch) {
    data.ciclo = cicloMatch[1];
    const [year, semester] = data.ciclo.split('-');
    const yearNum = parseInt(year);
    const semesterNum = parseInt(semester);
    
    // Verificar si es elegible (hasta 2023-2)
    if (yearNum > 2023 || (yearNum === 2023 && semesterNum > 2)) {
      issues.push('ciclo_no_elegible');
      data.elegible = false;
    } else {
      data.elegible = true;
    }
  }
  
  // Extraer curso aprobado
  const cursoMatch = message.match(/(?:computaci[√≥o]n|comp)\s*([123]|ninguno)/i);
  if (cursoMatch) {
    data.ultimoCurso = cursoMatch[1] === 'ninguno' ? 'ninguno' : `Computaci√≥n ${cursoMatch[1]}`;
  }
  
  // Extraer correo
  const correoMatch = message.match(/([a-zA-Z0-9._%+-]+@(?:uss\.edu\.pe|crece\.uss\.edu\.pe))/i);
  if (correoMatch) {
    data.correo = correoMatch[1].toLowerCase();
  }
  
  if (issues.length > 0) {
    data.issues = issues;
  }
  
  return data;
}

// Configuraci√≥n del contexto del Centro de Inform√°tica USS (sin cambios)
const SYSTEM_CONTEXT = `Eres un asistente virtual del Centro de Inform√°tica de la Universidad Se√±or de Sip√°n (USS) en Chiclayo, Per√∫. Tu objetivo es ayudar al estudiante de manera natural y resolutiva, usando la informaci√≥n oficial y los mensajes institucionales. Solo deriva al contacto oficial si la consulta es demasiado espec√≠fica o no puedes resolverla.

IMPORTANTE: El Programa de Computaci√≥n para Egresados es para TODOS los egresados de pregrado de CUALQUIER carrera que tengan pendiente la acreditaci√≥n de cursos de computaci√≥n. NO menciones espec√≠ficamente "Ingenier√≠a de Sistemas" u otras carreras individuales; mant√©n el enfoque general para todas las carreras de pregrado.

INFORMACI√ìN INSTITUCIONAL:
- Universidad: Universidad Se√±or de Sip√°n (USS)
- √Årea: Centro de Inform√°tica  
- Ubicaci√≥n: Chiclayo, Per√∫
- Email: centrodeinformatica@uss.edu.pe
- Tel√©fono: 986 724 506

SERVICIOS QUE OFRECES:
1. **Programa de Computaci√≥n para Egresados:**
   Invitaci√≥n: Si a√∫n no has acreditado el curso de Computaci√≥n para Egresados, puedes hacerlo ahora. El programa es 100% virtual y de autoaprendizaje, disponible las 24 horas y sin horarios fijos. Para inscribirte, escribe y recibir√°s los pasos de inscripci√≥n.

   Informaci√≥n general:
   - Dirigido a egresados de pregrado (de cualquier carrera) hasta el ciclo 2023-2 que tengan pendiente la acreditaci√≥n de cursos de computaci√≥n.
   - Modalidad: 100% virtual (Aula USS)
   - Contenidos:
     - Computaci√≥n 1: Microsoft Word (Intermedio ‚Äì Avanzado)
     - Computaci√≥n 2: Microsoft Excel (B√°sico ‚Äì Intermedio ‚Äì Avanzado)
     - Computaci√≥n 3: IBM SPSS y MS Project
   - Costo por nivel: S/ 200
   - Manual con pasos para registro disponible.

   Confirmaci√≥n de registro:
   Al inscribirte, recibir√°s acceso al Aula USS (www.aulauss.edu.pe) con tu usuario y contrase√±a institucional. El curso es autogestionado y debes completarlo antes del 31 de diciembre. Al finalizar, responde al correo para inscribirte al siguiente nivel.

   Finalizaci√≥n y acceso al siguiente nivel:
   Al terminar un nivel, puedes inscribirte en el siguiente realizando el pago y enviando el comprobante a centrodeinformatica@uss.edu.pe. Puedes llevar los niveles en paralelo.

2. **Constancias y Certificados:**
   - Constancia de Estudios
   - Constancia de Notas  
   - Constancia de Ranking
   - Certificado de Estudios
   - Costo: S/ 15.00 por documento
   - Tiempo: 3-5 d√≠as h√°biles

3. **Horarios de Atenci√≥n:**
   - Presencial: Lunes a Viernes 8:00 AM - 6:00 PM, S√°bados 8:00 AM - 12:00 PM
   - Virtual: 24/7 trav√©s del chat
   - Email: Respuesta en 24-48 horas

4. **Informaci√≥n Acad√©mica:**
   - Matr√≠cula y procesos acad√©micos
   - Cursos: Computaci√≥n I, II, III
   - Modalidades de pago

PERSONALIDAD:
- Profesional y amigable
- Usa emojis apropiados
- Proporciona informaci√≥n espec√≠fica y √∫til
- Enf√≥cate en el Programa de Computaci√≥n para Egresados como general para todas las carreras de pregrado.
- Siempre ofrece contactos para consultas complejas

RESPUESTAS:
- S√© espec√≠fico sobre los servicios del Centro de Inform√°tica
- Menciona costos, tiempos y requisitos cuando sea relevante
- Para dudas complejas, deriva a los contactos oficiales
- Mant√©n un tono profesional pero cercano`;

export default async function handler(req, res) {
  // Configurar CORS (sin cambios)
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'M√©todo no permitido' });
  }

  try {
    const { message, sessionId = 'default' } = req.body;

    if (!message) {
      return res.status(400).json({ error: 'Mensaje requerido' });
    }

    console.log('üì© Consulta recibida:', { sessionId, message: message.substring(0, 100) });

    // Extraer datos del estudiante del mensaje actual (sin cambios)
    const extractedData = extractStudentData(message);
    let currentData = studentData.get(sessionId) || {};
    currentData = { ...currentData, ...extractedData };
    currentData.lastActivity = Date.now();
    studentData.set(sessionId, currentData);

    // Determinar contexto adicional basado en elegibilidad (sin cambios)
    let additionalContext = '';
    if (currentData.ciclo && currentData.elegible === false) {
      additionalContext = `
      ATENCI√ìN: El estudiante indic√≥ que egres√≥ en ${currentData.ciclo}.
      Este ciclo NO ES ELEGIBLE para el programa (posterior a 2023-2).
      Debes informarle amablemente que no puede acceder al programa y sugerir alternativas.
      NO continues con el proceso de inscripci√≥n.
      `;
    } else if (currentData.ciclo && currentData.elegible === true) {
      additionalContext = `
      El estudiante egres√≥ en ${currentData.ciclo} - ES ELEGIBLE para el programa.
      Puedes continuar con el proceso de inscripci√≥n, incluyendo invitaci√≥n y detalles completos.
      `;
    }

    // Verificar API key de Gemini (sin cambios)
    if (!process.env.GEMINI_API_KEY) {
      console.log('‚ùå GEMINI_API_KEY no configurada');
      return res.status(500).json({ 
        error: 'API key no configurada',
        response: 'Lo siento, hay un problema de configuraci√≥n. Contacta a centrodeinformatica@uss.edu.pe o llama al 986 724 506.'
      });
    }

    // Obtener historial de sesi√≥n (sin cambios)
    let sessionHistory = studentSessions.get(sessionId) || [];
    
    // Agregar mensaje actual al historial
    sessionHistory.push({
      role: 'user',
      content: message
    });

    // Modelos a probar en orden (sin cambios, v√°lidos en 2025)
    const modelsToTry = [
      'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent',
      'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent',
      'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent',
      'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent',
      'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent'
    ];

    let botResponse = '';
    let lastError = null;
    for (const modelUrl of modelsToTry) {
      try {
        console.log(`ü§ñ Probando modelo: ${modelUrl}`);
        const response = await fetch(`${modelUrl}?key=${process.env.GEMINI_API_KEY}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [
              {
                parts: [
                  {
                    text: `Contexto del sistema: ${SYSTEM_CONTEXT}\n\n${additionalContext}\n\nDatos actuales del estudiante: ${JSON.stringify(currentData)}\n\nHistorial de conversaci√≥n:\n${sessionHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}\n\nResponde como asistente del Centro de Inform√°tica USS:`
                  }
                ]
              }
            ],
            generationConfig: {
              temperature: 0.6,
              maxOutputTokens: 768
            }
          })
        });

        if (!response.ok) {
          const errorData = await response.text();
          console.log(`‚ùå Error de Gemini (${modelUrl}):`, response.status, errorData);
          lastError = `Error de Gemini API: ${response.status} - ${errorData}`;
          continue; // Prueba el siguiente modelo
        }

        const data = await response.json();
        // ‚Üê FIX: Chequeo completo para evitar crash si no hay parts/text
        if (data.candidates && 
            data.candidates[0] && 
            data.candidates[0].content && 
            data.candidates[0].content.parts && 
            data.candidates[0].content.parts[0] && 
            data.candidates[0].content.parts[0].text) {
          botResponse = data.candidates[0].content.parts[0].text;
          console.log(`‚úÖ Respuesta recibida del modelo: ${modelUrl}`);
          break; // Salir del ciclo si funciona
        } else {
          console.log(`‚ùå Respuesta inv√°lida de Gemini (${modelUrl}):`, data);
          lastError = 'Respuesta inv√°lida de Gemini';
        }
      } catch (geminiError) {
        console.log(`‚ùå Error al conectar con Gemini (${modelUrl}):`, geminiError.message);
        lastError = geminiError.message;
      }
    }

    if (!botResponse) {
      return res.status(500).json({
        error: lastError || 'No se pudo obtener respuesta de ning√∫n modelo Gemini',
        response: 'Error temporal con el servicio de IA. Por favor intenta nuevamente o contacta al administrador.'
      });
    }

    // Agregar respuesta del bot al historial (sin cambios)
    sessionHistory.push({
      role: 'assistant',
      content: botResponse
    });

    // Limitar historial a √∫ltimos 10 intercambios
    if (sessionHistory.length > 20) {
      sessionHistory = sessionHistory.slice(-20);
    }

    // Guardar historial actualizado
    studentSessions.set(sessionId, sessionHistory);

    console.log('‚úÖ Respuesta enviada exitosamente');

    return res.status(200).json({ 
      response: botResponse,
      sessionId: sessionId,
      studentData: currentData,
      isEligible: currentData.elegible !== false
    });

  } catch (error) {
    console.error('‚ùå Error en el servidor:', error);
    
    return res.status(500).json({ 
      error: 'Error interno del servidor',
      response: 'Lo siento, hubo un problema t√©cnico. Por favor contacta a:\nüìß centrodeinformatica@uss.edu.pe\nüì± 986 724 506'
    });
  }
}